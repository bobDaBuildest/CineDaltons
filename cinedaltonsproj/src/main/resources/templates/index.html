<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CineDaltons</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<div id="licenseModal" class="modal"  style="display:block;">
    <div class="modal-content" style="max-width: 600px;">
        <h2>License and Terms of Service</h2>
        <p>Please review and accept the terms to continue using CineDaltons.</p>
        <div class="license-text">
            <p><strong>1. Acceptance:</strong> By accessing or using the Service, you agree to be bound by these Terms.</p>
            <p><strong>2. API Usage:</strong> This application relies on the TMDb API. Use of search features is subject to TMDb's terms of use.</p>
            <p><strong>3. Disclaimer:</strong> CineDaltons is a demonstration project. We assume no liability for the content or functionality.</p>
            <p><strong>4. Data:</strong> We use local storage for watchlist and preferences. No user data is transmitted to a server (simulated).</p>
        </div>
        <button class="btn submit-btn" onclick="acceptLicense()">Accept and Continue</button>
    </div>
</div>

<div id="appContent" class="hidden-app">
<header class="top-right">
    <button class="btn" onclick="showPreferencesModal()">Genre Preferences</button>
    <button class="btn" onclick="openModal('signupModal')">Sign Up</button>
    <button class="btn" onclick="openModal('signinModal')">Sign In</button>
</header>

<div class="container">
    <h1>Welcome to CineDaltons</h1>
    <p>Discover and track your favorite movies</p>
</div>

<form action="/search" method="get" class="search-section">
    <input type="text" name="query" id="searchInput" placeholder="Search movies..." required>
    <button type="submit" class="btn">Search</button>
</form>

<h2 style="text-align: center;">Search Results</h2>

<div id="results">
    <div th:if="${error}" style="color: red; width: 100%; text-align: center;">
        <h3 th:text="${error}">Error Message</h3>
    </div>

    <div th:each="movie : ${movies}" class="movie">

        <img th:if="${movie.posterPath != null}"
             th:src="${'https://image.tmdb.org/t/p/w200' + movie.posterPath}"
             alt="Movie Poster">
        <img th:if="${movie.posterPath == null}"
             src="https://via.placeholder.com/200x300?text=No+Image"
             alt="No Image">

        <h3 th:text="${movie.title}">Movie Title</h3>

        <p th:text="${movie.releaseDate}">2024</p>

        <button class="btn">Add to Watchlist</button>
    </div>
</div>

<button id="watchlist-toggle" onclick="toggleWatchlist()">
    Watchlist <span id="watchlist-badge">0</span>
</button>

<div id="watchlist-container" class="hidden">
    <h2>Your Watchlist</h2>
    <button class="btn" onclick="renderWatchlist()">Refresh</button>
    <div id="watchlist"></div>
</div>
</div>
<div id="signupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('signupModal')">&times;</span>
        <h2>Create an account</h2>
        <form id="signupForm" class="signup-validation">
            <label>Username</label>
            <input type="text" id="su_username" required maxlength="50"/>

            <label>First Name</label>
            <input type="text" id="su_first" required />

            <label>Last Name</label>
            <input type="text" id="su_last" required />

            <label>Email</label>
            <input type="email" id="su_email" required />

            <label>Password</label>
            <div class="password-container">
                <input type="password" id="su_password" required minlength="8"/>
            </div>

            <div id="strengthText"></div>
            <div id="strengthBar"></div>

            <label>Confirm Password</label>
            <input type="password" id="su_confirmPassword" required>

            <button type="submit" class="submit-btn">Create Account</button>
        </form>
    </div>
</div>

<div id="signinModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('signinModal')">&times;</span>
        <h2>Sign In</h2>
        <form id="signInForm">
            <label>Email</label>
            <input type="email" required />

            <label>Password</label>
            <input type="password" required />

            <div style="margin-top: 10px; text-align: right;">
                <button type="button" onclick="alert('Password reset link sent to your email (simulated).')" class="text-link">
                    Forgot Password?
                </button>
            </div>

            <button type="submit" class="submit-btn">Login</button>
        </form>
    </div>
</div>

<div id="genrePreferencesModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeModal('genrePreferencesModal')">&times;</span>
        <h2>Movie Genre Preferences</h2>
        <p>Select your favorite movie genres to get personalized recommendations!</p>

        <form id="movieGenreForm">
            <div class="form-group">
                <label for="prefUsername">Your Name</label> <input type="text" id="prefUsername" name="username" required>
            </div>

            <div class="form-group">
                <label>Select Your Favorite Movie Genres</label>
                <div class="checkbox-container" id="genreContainer">
                </div>
            </div>

            <div class="selected-count">
                Selected: <span id="selectedCount">0</span> genres
            </div>

            <div class="success-message" id="successMessage" style="display:none;">
                Your genre preferences have been saved successfully!
            </div>

            <div class="form-actions">
                <button type="button" class="btn secondary-btn" id="resetBtn">Reset Selection</button>
                <button type="submit" class="btn submit-btn">Save Preferences</button>
            </div>
        </form>
        <hr>
        <h3>My Saved Preferences</h3>
        <div id="preferencesDisplay">No genre preferences saved yet.</div>
        <button class="btn" onclick="showPreferencesDisplay()">View/Refresh Saved</button>

    </div> </div><script>
    // API Configuration
    const API_KEY = "fbdfbb87f57e7fd7d5778016a7b26f49";

    // 1. Λειτουργίες License (Άδεια Χρήσης)
    function checkLicense() {
        // Ελέγχουμε αν ο χρήστης έχει ήδη αποδεχτεί
        const accepted = localStorage.getItem('licenseAccepted');

        // Αν ΔΕΝ έχει αποδεχτεί, εμφανίζουμε το modal
        if (!accepted) {
            document.getElementById('licenseModal').style.display = "block";
        }
    }

    function acceptLicense() {
        // Αποθηκεύουμε την αποδοχή για να μην ξαναενοχλήσουμε τον χρήστη
        localStorage.setItem('licenseAccepted', 'true');
        document.getElementById('licenseModal').style.display = "none";
    }

    function loadLicenseText() {
        fetch('LICENSE.txt')
            .then(response => {
                if (!response.ok) {
                    throw new Error("HTTP error " + response.status);
                }
                return response.text();
            })
            .then(text => {
                document.getElementById('licenseText').textContent = text;
            })
            .catch(err => {
                console.error("Error:", err);
                document.getElementById('licenseText').textContent = "Can't find LICENSE.txt";
            });
    }

    // Modal functions
    function openModal(id) {
        document.getElementById(id).style.display = "block";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(e) {
        document.querySelectorAll(".modal").forEach(modal => {
            if (e.target === modal){
                if (modal.id !== 'licenseModal') {
                    modal.style.display = "none";
                }
            }
        });
    };

    // Watchlist functions (No changes needed here)
    function getWatchlist() {
        return JSON.parse(localStorage.getItem("watchlist") || "[]");
    }

    function saveWatchlist(list) {
        localStorage.setItem("watchlist", JSON.stringify(list));
    }

    // Search movies function
    async function searchMovies() {
        const query = document.getElementById("searchInput").value;
        if (!query) return;

        try {
            const response = await fetch(
                `https://api.themoviedb.org/3/search/movie?query=${query}`,
                {
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`,
                        "Content-Type": "application/json;charset=utf-8"
                    }
                }
            );

            const data = await response.json();
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "";

            if (data.results && data.results.length > 0) {
                data.results.forEach(movie => {
                    const posterPath = movie.poster_path
                        ? `https://image.tmdb.org/t/p/w200${movie.poster_path}`
                        : 'https://via.placeholder.com/200x300?text=No+Image';

                    const card = document.createElement("div");
                    card.className = "movie";
                    card.innerHTML = `
                            <img src="${posterPath}" alt="${movie.title}">
                            <h3>${movie.title}</h3>
                            <p>${movie.release_date ? movie.release_date.substring(0,4) : 'N/A'}</p>
                            <button class="btn" onclick='addToWatchlist(${JSON.stringify(movie)})'>
                                Add to Watchlist
                            </button>
                        `;
                    resultsDiv.appendChild(card);
                });
            } else {
                resultsDiv.innerHTML = "<p>No movies found. Try a different search term.</p>";
            }
        } catch (error) {
            console.error("Error fetching movies:", error);
            document.getElementById("results").innerHTML = "<p>Error searching for movies. Please try again.</p>";
        }
    }

    // Add to watchlist
    function addToWatchlist(movie) {
        let list = getWatchlist();

        if (!list.some(m => m.id === movie.id)) {
            list.push(movie);
            saveWatchlist(list);
            alert(`${movie.title} added to watchlist!`);
        } else {
            alert(`${movie.title} is already in your watchlist!`);
        }

        renderWatchlist();
    }

    // Remove from watchlist
    function removeFromWatchlist(id) {
        let list = getWatchlist().filter(m => m.id !== id);
        saveWatchlist(list);
        renderWatchlist();
    }

    // Update badge count
    function updateBadge() {
        document.getElementById("watchlist-badge").innerText = getWatchlist().length;
    }

    // Render watchlist
    function renderWatchlist() {
        const items = getWatchlist();
        const container = document.getElementById("watchlist");
        container.innerHTML = "";

        updateBadge();

        if (items.length === 0) {
            container.innerHTML = "<p>Your watchlist is empty.</p>";
            return;
        }

        items.forEach(movie => {
            const item = document.createElement("div");
            item.className = "watchlist-item";
            item.innerHTML = `
                    <span>${movie.title}</span>
                    <button class="btn" onclick="removeFromWatchlist(${movie.id})">X</button>
                `;
            container.appendChild(item);
        });
    }

    // Toggle watchlist panel
    function toggleWatchlist() {
        document.getElementById("watchlist-container").classList.toggle("hidden");
    }

    // Κλήση όλων των αρχικοποιήσεων κατά τη φόρτωση του DOM
    document.addEventListener('DOMContentLoaded', function() {
        loadLicenseText();// Φορτώνει το κείμενο της άδειας
        checkLicense(); // Ελέγχει αν έχει αποδεχτεί ο χρήστης την άδεια

        renderWatchlist();
        // Δεν καλούμε την initializeGenreForm εδώ, καθώς γίνεται στην showPreferencesModal

        // Allow search with Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMovies();
            }
        });
    });

    // -------------------------------------------------------------
    // ΛΕΙΤΟΥΡΓΙΕΣ ΓΙΑ ΤΙΣ ΠΡΟΤΙΜΗΣΕΙΣ ΧΡΗΣΤΗ (USER PREFERENCES)
    // -------------------------------------------------------------
    const movieGenres = [
        { name: "Action", icon: "A" },
        { name: "Adventure", icon: "AV" },
        { name: "Animation", icon: "AN" },
        { name: "Comedy", icon: "C" },
        { name: "Crime", icon: "CR" },
        { name: "Documentary", icon: "D" },
        { name: "Drama", icon: "DR" },
        { name: "Fantasy", icon: "F" },
        { name: "Horror", icon: "H" },
        { name: "Mystery", icon: "M" },
        { name: "Romance", icon: "R" },
        { name: "Science Fiction", icon: "SF" },
        { name: "Thriller", icon: "T" },
        { name: "Western", icon: "W" }
    ];

    function createGenreCheckboxes() {
        const container = document.getElementById('genreContainer');
        if (!container) return;

        container.innerHTML = '';
        movieGenres.forEach(genre => {
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'checkbox-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'genre-' + genre.name.toLowerCase().replace(/\s+/g, '-');
            checkbox.name = 'genres';
            checkbox.value = genre.name;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.style.marginLeft = '10px';

            const icon = document.createElement('span');
            icon.className = 'genre-icon';
            icon.textContent = genre.icon;

            label.appendChild(icon);
            label.appendChild(document.createTextNode(genre.name));

            checkboxItem.appendChild(checkbox);
            checkboxItem.appendChild(label);
            container.appendChild(checkboxItem);
        });
    }

    function updateSelectedCount() {
        const selectedCountSpan = document.getElementById('selectedCount');
        if (!selectedCountSpan) return;

        const selectedCount = document.querySelectorAll('#genreContainer input:checked').length;
        selectedCountSpan.textContent = selectedCount;
    }

    function resetForm() {
        document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('prefUsername').value = '';
        updateSelectedCount();
    }

    function showPreferencesDisplay() {
        const preferences = localStorage.getItem('userGenrePreferences');
        const display = document.getElementById('preferencesDisplay');

        if (preferences && display) {
            const data = JSON.parse(preferences);
            display.innerHTML = `
                <p><strong>Name:</strong> ${data.username}</p>
                <p><strong>Favorite Genres:</strong> ${data.selectedGenres.join(', ') || 'None selected'}</p>
                <p><strong>Last Updated:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
            `;
        } else if (display) {
            display.innerHTML = '<p>No genre preferences saved yet. Please complete the survey.</p>';
        }
    }

    function handleGenreFormSubmit(event) {
    if (event && event.preventDefault) {
        event.preventDefault();
}
        const usernameInput = document.getElementById('prefUsername');
        if (!usernameInput || !usernameInput.value) {
            alert('Please enter your name');
            return;
        }

        const selectedGenres = Array.from(document.querySelectorAll('#genreContainer input:checked'))
            .map(checkbox => checkbox.value);

        const userPreferences = {
            username: usernameInput.value,
            selectedGenres,
            timestamp: new Date().toISOString()
        };

        localStorage.setItem('userGenrePreferences', JSON.stringify(userPreferences));

        const successMessage = document.getElementById('successMessage');
        if (successMessage) {
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        showPreferencesDisplay(); // ΚΛΕΙΔΙ: Ενημερώνουμε το κάτω display αμέσως μετά την αποθήκευση
        alert('Preferences saved successfully!');
    }

    // Σωστή συνάρτηση για άνοιγμα του modal των προτιμήσεων
    function showPreferencesModal() {
        initializeGenreForm();
        showPreferencesDisplay(); // ΚΛΕΙΔΙ: Ενημερώνουμε το κάτω display αμέσως πριν ανοίξουμε το modal
        openModal('genrePreferencesModal');
    }

    function initializeGenreForm() {
        createGenreCheckboxes();

        const preferences = localStorage.getItem('userGenrePreferences');

        if (preferences) {
            const data = JSON.parse(preferences);

            // 1. Συμπλήρωση του πεδίου ονόματος
            const usernameInput = document.getElementById('prefUsername');
            if (usernameInput) {
                usernameInput.value = data.username || '';
            }

            // 2. Συμπλήρωση των checkboxes
            document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
                if (data.selectedGenres.includes(checkbox.value)) {
                    checkbox.checked = true;
                } else {
                    checkbox.checked = false;
                }
            });
        } else {
            // Εάν δεν υπάρχουν αποθηκευμένα, καθαρίζουμε τη φόρμα
            resetForm();
        }

        updateSelectedCount();

        document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
        checkbox.removeEventListener('change', updateSelectedCount);
            checkbox.addEventListener('change', updateSelectedCount);
        });

        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn){
        resetBtn.removeEventListener('click', resetForm);
        resetBtn.addEventListener('click', resetForm);
}
        const form = document.getElementById('movieGenreForm');
        if (form) form.addEventListener('submit', handleGenreFormSubmit);
    }

<script src="genres.js"></script>
<script src="script.js"></script>
</body>
</html>
