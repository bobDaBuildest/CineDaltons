<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>CineDaltons</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" href="/css/style.css">
    <style>
        /* Βασική δομή για να λειτουργήσουν τα modals και οι κρυφές κλάσεις */
        .modal {
            display: none; /* Κρύβει όλα τα modals από προεπιλογή */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            color: #333;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .hidden-app {
            display: none; /* Αυτό θα κρύψει το κύριο περιεχόμενο μέχρι την αποδοχή της άδειας */
        }
        .top-right {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn {
            background-color: #fdd835;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: 10px;
        }
        .btn:hover {
            background-color: #ffeb3b;
        }

        /* Προσομοίωση του style.css για το watchlist toggle */
        #watchlist-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px;
            background-color: #fdd835;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            display: none; /* Αρχικά κρυμμένο */
        }
         #watchlist-toggle:hover {
            background-color: #ffeb3b;
            transform: scale(1.05);
            }
        #watchlist-container {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 300px;
            background-color: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        .hidden {
            display: none;
        }
        .movie {
            border: 1px solid #444;
            padding: 10px;
            margin: 10px;
            display: inline-block;
            width: 200px;
            text-align: center;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
         .watchlist-item {
            border-bottom: 1px solid #444;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .watchlist-item:last-child {
            border-bottom: none;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        .welcome-message {
            font-size: 14px;
            color: #fdd835;
        }
        .auth-forms input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body style="background-color: #1a1a1a; color: white; font-family: sans-serif;">

<div id="licenseModal" class="modal" style="display:block;">
    <div class="modal-content">
        <h2>License and Terms of Service</h2>
        <p>Please review and accept the terms to continue using CineDaltons.</p>
        <div class="license-text">
            <p><strong>1. Acceptance:</strong> By accessing or using the Service, you agree to be bound by these Terms.</p>
            <p><strong>2. API Usage:</strong> This application relies on the TMDb API. Use of search features is subject to TMDb's terms of use.</p>
            <p><strong>3. Disclaimer:</strong> CineDaltons is a demonstration project. We assume no liability for the content or functionality.</p>
            <p><strong>4. Data:</strong> We use local storage for watchlist and preferences. No user data is transmitted to a server (simulated).</p>
        </div>
        <button class="btn submit-btn" onclick="acceptLicense()">Accept and Continue</button>
    </div>
</div>

<div id="appContent" class="hidden-app">
    <header class="top-right">
        <div id="auth-buttons">
            <button class="btn" onclick="showPreferencesModal()">Genre Preferences</button>
            <button class="btn" onclick="openModal('signupModal')">Sign Up</button>
            <button class="btn" onclick="openModal('signinModal')">Sign In</button>
        </div>
    </header>

    <div class="container" style="text-align: center; padding-top: 50px;">
        <img th:if="${error}" src="https://via.placeholder.com/100x100?text=Error" alt="Error" style="display: none;"/>
        <img th:if="${error}" src="/images/error-icon.png" alt="Error" style="display: none;"/>

        <h1>Welcome to CineDaltons</h1>
        <p>Discover and track your favorite movies</p>
    </div>

    <form action="/search" method="get" class="search-section" style="text-align: center; margin: 20px auto;">
        <input type="text" name="query" id="searchInput" placeholder="Search movies..." required
               style="padding: 10px; width: 400px; border-radius: 4px; border: none; background-color: #333; color: white;">
        <button type="button" class="btn" onclick="searchMovies()">Search</button>
    </form>

    <h2 style="text-align: center;">Search Results</h2>

    <div id="results" style="text-align: center;">

        <div th:each="movie : ${movies}" class="movie">

            <a th:href="@{/movie/{id}(id=${movie.id})}" style="text-decoration: none; color: inherit; cursor: pointer;">

                <img th:if="${movie.posterPath != null}"
                     th:src="${'https://image.tmdb.org/t/p/w200' + movie.posterPath}"
                     alt="Movie Poster" style="max-width: 100%; height: auto;">
                <img th:if="${movie.posterPath == null}"
                     src="https://via.placeholder.com/200x300?text=No+Image"
                     alt="No Image" style="max-width: 100%; height: auto;">

                <h3 th:text="${movie.title}" style="font-size: 1.1em; margin: 10px 0;">Movie Title</h3>
            </a>

            <p th:text="${movie.releaseDate}">2024</p>

            <button class="btn"
                    th:data-movie="${movie.jsonRepresentation}"
                    onclick='addToWatchlist(JSON.parse(this.getAttribute("data-movie")))'
            >
                Add to Watchlist
            </button>
        </div>

        <div th:if="${error}" style="color: red; width: 100%; text-align: center;" th:text="${error}">
            Error message here
        </div>
    </div>
</div>

<button id="watchlist-toggle" onclick="toggleWatchlist()">
    Watchlist <span id="watchlist-badge">0</span>
</button>

<div id="watchlist-container" class="hidden">
    <h2>Your Watchlist</h2>
    <button class="btn" onclick="renderWatchlist()">Refresh</button>
    <div id="watchlist"></div>
</div>

<div id="signupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('signupModal')">&times;</span>
        <h2>Create an account</h2>
        <form id="signupForm" class="signup-validation">
            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Username</label>
                <input type="text" id="su_username" required maxlength="50" style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">First Name</label>
                <input type="text" id="su_first" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Last Name</label>
                <input type="text" id="su_last" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Email</label>
                <input type="email" id="su_email" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Password</label>
                <div class="password-container">
                    <input type="password" id="su_password" required minlength="8" style="width: 100%; padding: 8px; box-sizing: border-box;"/>
                </div>
            </div>

            <div id="strengthText"></div>
            <div id="strengthBar"></div>

            <div style="margin-bottom: 20px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Confirm Password</label>
                <input type="password" id="su_confirmPassword" required style="width: 100%; padding: 8px; box-sizing: border-box;">
            </div>
            <button type="submit" class="submit-btn">Create Account</button>
        </form>
    </div>
</div>

<div id="signinModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('signinModal')">&times;</span>
        <h2>Sign In</h2>
        <form id="signInForm">
            <label style="color: black;">Email</label>
            <input type="email" id="si_email" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            <label style="color: black;">Password</label>
            <input type="password" id="si_password" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            <div style="margin-top: 10px; text-align: right;">
                <button type="button" onclick="alert('Password reset link sent to your email (simulated).')" class="text-link">
                    Forgot Password?
                </button>
            </div>
            <button type="submit" class="submit-btn">Login</button>
        </form>
    </div>
</div>

<div id="genrePreferencesModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeModal('genrePreferencesModal')">&times;</span>
        <h2>Movie Genre Preferences</h2>
        <p>Select your favorite movie genres to get personalized recommendations!</p>

        <form id="movieGenreForm">
            <div class="form-group">
                <label for="prefUsername" style="color: black;">Your Name</label> <input type="text" id="prefUsername" name="username" required>
            </div>

            <div class="form-group">
                <label style="color: black;">Select Your Favorite Movie Genres</label>
                <div class="checkbox-container" id="genreContainer">
                </div>
            </div>

            <div class="selected-count" style="color: black;">
                Selected: <span id="selectedCount">0</span> genres
            </div>

            <div class="success-message" id="successMessage" style="display:none; color: green;">
                Your genre preferences have been saved successfully!
            </div>

            <div class="form-actions">
                <button type="button" class="btn secondary-btn" id="resetBtn">Reset Selection</button>
                <button type="submit" class="btn submit-btn">Save Preferences</button>
            </div>
        </form>
        <hr>
        <h3 style="color: black;">My Saved Preferences</h3>
        <div id="preferencesDisplay" style="color: black;">No genre preferences saved yet.</div>
        <button class="btn" onclick="showPreferencesDisplay()">View/Refresh Saved</button>

    </div>
</div>

<script>
    // API Configuration
    // ΠΡΟΣΟΧΗ: Το API key είναι δημόσιο, αλλά είναι καλό να μην το εκθέτετε σε πραγματική εφαρμογή.
    const API_KEY = "fbdfbb87f57e7fd7d5778016a7b26f49";

    // ==============================================
    // ΚΕΝΤΡΙΚΗ ΑΛΛΑΓΗ: Authentication State Management
    // ==============================================
    let currentUser = null;

    //  Authentication Functions
    function setCurrentUser(user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(user));
        updateUIForAuthState();
         renderWatchlist();
    }

    function clearCurrentUser() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        updateUIForAuthState();
         renderWatchlist();
    }

    function updateUIForAuthState() {
        const watchlistToggle = document.getElementById('watchlist-toggle');
        const authButtons = document.getElementById('auth-buttons');

        if (currentUser) {
            // Εμφάνιση watchlist και αλλαγή των auth buttons
            watchlistToggle.style.display = 'block';
            authButtons.innerHTML = `
                <div class="user-info">
                    <span class="welcome-message">Welcome, ${currentUser.username || currentUser.email}</span>
                    <button class="btn" onclick="showPreferencesModal()">Genre Preferences</button>
                    <button class="btn" onclick="logout()">Logout</button>
                </div>
            `;
        } else {
            // Απόκρυψη watchlist και εμφάνιση sign in/sign up
            watchlistToggle.style.display = 'none';
            document.getElementById('watchlist-container').classList.add('hidden');
            authButtons.innerHTML = `
                <button class="btn" onclick="showPreferencesModal()">Genre Preferences</button>
                <button class="btn" onclick="openModal('signupModal')">Sign Up</button>
                <button class="btn" onclick="openModal('signinModal')">Sign In</button>
            `;
        }
    }

    function logout() {
        clearCurrentUser();
        alert('Logged out successfully!');
        renderWatchlist(); // Ενημέρωση του badge (θα γίνει 0)
    }
    // 1. Λειτουργίες License (Άδεια Χρήσης)
    function checkLicense() {
        const accepted = localStorage.getItem('licenseAccepted');
        const licenseModal = document.getElementById('licenseModal');
        const appContent = document.getElementById('appContent');

        if (!accepted) {
            licenseModal.style.display = "block";
            appContent.style.display = "none";
        } else {
            licenseModal.style.display = "none";
            appContent.style.display = "block"; // Εμφάνιση περιεχομένου μετά την αποδοχή
        }
    }

    function acceptLicense() {
        localStorage.setItem('licenseAccepted', 'true');
        document.getElementById('licenseModal').style.display = "none";
        document.getElementById('appContent').style.display = "block"; // Εμφάνιση του κύριου περιεχομένου
    }

    // Η συνάρτηση loadLicenseText() δεν μπορεί να φορτώσει το αρχείο LICENSE.txt σε απλό περιβάλλον browser
    // χωρίς server, οπότε την σχολιάζω/αφαιρώ την κλήση της, κρατώντας το κείμενο απευθείας στο HTML.
    /*
    function loadLicenseText() {
        fetch('LICENSE.txt')
            .then(response => {
                if (!response.ok) {
                    throw new Error("HTTP error " + response.status);
                }
                return response.text();
            })
            .then(text => {
                // Προσοχή: Δεν υπάρχει πλέον στο HTML
                // document.getElementById('licenseText').textContent = text;
            })
            .catch(err => {
                console.error("Error:", err);
            });
    }
    */

    // Modal functions
    function openModal(id) {
        document.getElementById(id).style.display = "block";
    }

    function closeModal(id) {
        document.getElementById(id).style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function(e) {
        document.querySelectorAll(".modal").forEach(modal => {
            if (e.target === modal){
                if (modal.id !== 'licenseModal') { // Το licenseModal πρέπει να κλείνει μόνο με το Accept
                    modal.style.display = "none";
                }
            }
        });
    };

    // ΚΕΝΤΡΙΚΗ ΑΛΛΑΓΗ: User-specific Watchlist
    // ==============================================
    function getWatchlist() {
        if (!currentUser) return [];
        const userWatchlist = JSON.parse(localStorage.getItem(`watchlist_${currentUser.id}`) || "[]");
        return userWatchlist;
    }

    function saveWatchlist(list) {
        if (!currentUser) return;
        localStorage.setItem(`watchlist_${currentUser.id}`, JSON.stringify(list));
    }

    // Search movies function (Διορθωμένο για να δουλεύει με το button type="button" και το JS)
    async function searchMovies() {
        const query = document.getElementById("searchInput").value;
        const resultsDiv = document.getElementById("results");

        if (!query) {
            resultsDiv.innerHTML = "<p>Please enter a movie title to search.</p>";
            return;
        }

        resultsDiv.innerHTML = "<h3>Searching...</h3>";

        try {
            const response = await fetch(
                `https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(query)}&api_key=${API_KEY}`
                // Χρησιμοποιώ την πιο απλή μορφή με api_key στην query string για ευκολία
            );

            const data = await response.json();
            resultsDiv.innerHTML = "";

            if (data.results && data.results.length > 0) {
                data.results.forEach(movie => {
                    const posterPath = movie.poster_path
                        ? `https://image.tmdb.org/t/p/w200${movie.poster_path}`
                        : 'https://via.placeholder.com/200x300?text=No+Image';

                    const card = document.createElement("div");
                    card.className = "movie";
                    card.innerHTML = `
                            <a href="/movie/${movie.id}" style="text-decoration: none; color: inherit;">
                            <img src="${posterPath}" alt="${movie.title}" style="max-width: 100%; height: auto; cursor: pointer;">
                            <h3 style="font-size: 1.1em; margin: 10px 0; cursor: pointer;">${movie.title}</h3>
                            </a>
                            <p style="margin: 5px 0;">${movie.release_date ? movie.release_date.substring(0,4) : 'N/A'}</p>
                            <button class="btn" onclick='event.preventDefault(); addToWatchlist(${JSON.stringify(movie)})'>
                                Add to Watchlist
                            </button>
                        `;
                    resultsDiv.appendChild(card);
                });
            } else {
                resultsDiv.innerHTML = "<p>No movies found. Try a different search term.</p>";
            }
        } catch (error) {
            console.error("Error fetching movies:", error);
            document.getElementById("results").innerHTML = "<p>Error searching for movies. Please check your API key or network connection.</p>";
        }
    }


    // Add to watchlist
    function addToWatchlist(movie) {
     if (!currentUser) {
            alert('Please sign in to add movies to your watchlist!');
            openModal('signinModal');
            return;
        }
        let list = getWatchlist();

        if (!list.some(m => m.id === movie.id)) {
            list.push(movie);
            saveWatchlist(list);
            alert(`${movie.title} added to watchlist!`);
        } else {
            alert(`${movie.title} is already in your watchlist!`);
        }

        renderWatchlist();
    }

    // Remove from watchlist
    function removeFromWatchlist(id) {
     if (!currentUser) return;
        let list = getWatchlist().filter(m => m.id !== id);
        saveWatchlist(list);
        renderWatchlist();
    }

    // Update badge count
    function updateBadge() {
        document.getElementById("watchlist-badge").innerText = getWatchlist().length;
    }

    // Render watchlist
    function renderWatchlist() {
        const items = getWatchlist();
        const container = document.getElementById("watchlist");
        container.innerHTML = "";

        updateBadge();
         if (!currentUser) {
            container.innerHTML = "<p>Please sign in to view your watchlist</p>";
            return;
        }

        if (items.length === 0) {
            container.innerHTML = "<p>Your watchlist is empty.</p>";
            return;
        }

        items.forEach(movie => {
            const item = document.createElement("div");
            item.className = "watchlist-item";
            item.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 5px 0;";
            item.innerHTML = `
                    <span>${movie.title}</span>
                    <button class="btn" style="padding: 5px 10px;" onclick="removeFromWatchlist(${movie.id})">X</button>
                `;
            container.appendChild(item);
        });
    }

    // Toggle watchlist panel
    function toggleWatchlist() {
      if (!currentUser) {
            alert('Please sign in to view your watchlist!');
            openModal('signinModal');
            return;
        }
        document.getElementById("watchlist-container").classList.toggle("hidden");

        // Ενημέρωση της λίστας κάθε φορά που ανοίγει
        if (!document.getElementById("watchlist-container").classList.contains("hidden")) {
            renderWatchlist();
        }
    }

    // -------------------------------------------------------------
    // ΛΕΙΤΟΥΡΓΙΕΣ ΓΙΑ ΤΙΣ ΠΡΟΤΙΜΗΣΕΙΣ ΧΡΗΣΤΗ (USER PREFERENCES)
    // -------------------------------------------------------------
    const movieGenres = [
        { name: "Action", icon: "A" },
        { name: "Adventure", icon: "AV" },
        { name: "Animation", icon: "AN" },
        { name: "Comedy", icon: "C" },
        { name: "Crime", icon: "CR" },
        { name: "Documentary", icon: "D" },
        { name: "Drama", icon: "DR" },
        { name: "Fantasy", icon: "F" },
        { name: "Horror", icon: "H" },
        { name: "Mystery", icon: "M" },
        { name: "Romance", icon: "R" },
        { name: "Science Fiction", icon: "SF" },
        { name: "Thriller", icon: "T" },
        { name: "Western", icon: "W" }
    ];

    function createGenreCheckboxes() {
        const container = document.getElementById('genreContainer');
        if (!container) return;

        container.innerHTML = '';
        movieGenres.forEach(genre => {
            const checkboxItem = document.createElement('div');
            checkboxItem.className = 'checkbox-item';
            checkboxItem.style.cssText = 'display: inline-block; margin: 5px;';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'genre-' + genre.name.toLowerCase().replace(/\s+/g, '-');
            checkbox.name = 'genres';
            checkbox.value = genre.name;

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.style.marginLeft = '5px';
            label.style.color = 'black'; // Επειδή το modal-content είναι λευκό

            const icon = document.createElement('span');
            icon.className = 'genre-icon';
            icon.textContent = genre.icon;
            icon.style.cssText = 'background-color: #fdd835; padding: 2px 5px; border-radius: 3px; font-weight: bold; color: black;';

            label.appendChild(icon);
            label.appendChild(document.createTextNode(' ' + genre.name));

            checkboxItem.appendChild(checkbox);
            checkboxItem.appendChild(label);
            container.appendChild(checkboxItem);
        });
    }

    function updateSelectedCount() {
        const selectedCountSpan = document.getElementById('selectedCount');
        if (!selectedCountSpan) return;

        const selectedCount = document.querySelectorAll('#genreContainer input:checked').length;
        selectedCountSpan.textContent = selectedCount;
    }

    function resetForm() {
        document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('prefUsername').value = '';
        updateSelectedCount();
    }

    function showPreferencesDisplay() {
        const preferences = localStorage.getItem('userGenrePreferences');
        const display = document.getElementById('preferencesDisplay');

        if (preferences && display) {
            const data = JSON.parse(preferences);
            display.innerHTML = `
                <p><strong>Name:</strong> ${data.username}</p>
                <p><strong>Favorite Genres:</strong> ${data.selectedGenres.join(', ') || 'None selected'}</p>
                <p><strong>Last Updated:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
            `;
        } else if (display) {
            display.innerHTML = '<p>No genre preferences saved yet. Please complete the survey.</p>';
        }
    }

    function handleGenreFormSubmit(event) {
        if (event && event.preventDefault) {
            event.preventDefault();
        }
         if (!currentUser) {
            alert('Please sign in to save preferences!');
            openModal('signinModal');
            return;
        }
        const usernameInput = document.getElementById('prefUsername');
        if (!usernameInput || !usernameInput.value) {
            alert('Please enter your name');
            return;
        }

        const selectedGenres = Array.from(document.querySelectorAll('#genreContainer input:checked'))
            .map(checkbox => checkbox.value);

        const userPreferences = {
            username: usernameInput.value,
            selectedGenres,
            timestamp: new Date().toISOString()
        };

        localStorage.setItem('userGenrePreferences', JSON.stringify(userPreferences));

        const successMessage = document.getElementById('successMessage');
        if (successMessage) {
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        showPreferencesDisplay();
        alert('Preferences saved successfully!');
    }

    function showPreferencesModal() {
        initializeGenreForm();
        showPreferencesDisplay();
        openModal('genrePreferencesModal');
    }

    function initializeGenreForm() {
        createGenreCheckboxes(); // Δημιουργεί τα checkboxes

        const preferences = localStorage.getItem('userGenrePreferences');

        if (preferences) {
            const data = JSON.parse(preferences);

            // 1. Συμπλήρωση του πεδίου ονόματος
            const usernameInput = document.getElementById('prefUsername');
            if (usernameInput) {
                usernameInput.value = data.username || '';
            }

            // 2. Συμπλήρωση των checkboxes (πρέπει να γίνει *μετά* την createGenreCheckboxes)
            document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
                if (data.selectedGenres && data.selectedGenres.includes(checkbox.value)) {
                    checkbox.checked = true;
                } else {
                    checkbox.checked = false;
                }
            });
        } else {
            resetForm();
        }

        updateSelectedCount();

        // 3. Προσθήκη Event Listeners
        document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.removeEventListener('change', updateSelectedCount); // Αφαίρεση για αποφυγή διπλοεγγραφών
            checkbox.addEventListener('change', updateSelectedCount);
        });

        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn){
            resetBtn.removeEventListener('click', resetForm);
            resetBtn.addEventListener('click', resetForm);
        }

        // Αφαίρεση και επαναπροσθήκη του submit listener
        const form = document.getElementById('movieGenreForm');
        if (form) {
            form.removeEventListener('submit', handleGenreFormSubmit);
            form.addEventListener('submit', handleGenreFormSubmit);
        }
    }

    // Κλήση όλων των αρχικοποιήσεων κατά τη φόρτωση του DOM
    document.addEventListener('DOMContentLoaded', function() {
        checkLicense(); // Ελέγχει αν έχει αποδεχτεί ο χρήστης την άδεια και εμφανίζει το περιεχόμενο

           // Έλεγχος αν υπάρχει αποθηκευμένος χρήστης
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            updateUIForAuthState();
        } else {
            updateUIForAuthState();
        }

        renderWatchlist(); // Αρχική φόρτωση του badge/watchlist
        // Η initializeGenreForm() καλείται μόνο όταν ανοίγει το Preferences Modal

         const signupForm = document.getElementById('signupForm');
        if (signupForm) {
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();

                 const username = document.getElementById('su_username').value;
                const email = document.getElementById('su_email').value;
                const password = document.getElementById('su_password').value;
                const confirmPassword = document.getElementById('su_confirmPassword').value;

                if (password !== confirmPassword) {
                    alert('Passwords do not match!');
                    return;
                }
                // Προσομοίωση login (για demo)
                const user = {
                    id: 1,
                    username: email.split('@')[0],
                    email: email,
                    name: 'Demo User'
                };

                setCurrentUser(user);

                closeModal('signupModal');
                alert('Account created successfully!');
                signupForm.reset();
            });
        }
            const signinForm = document.getElementById('signInForm');
        if (signinForm) {
            signinForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // ΠΡΟΣΟΧΗ: Τα IDs πρέπει να υπάρχουν στα inputs!
                const emailInput = document.getElementById('si_email');
                const passwordInput = document.getElementById('si_password');

                if (!emailInput || !passwordInput) {
                    alert('Form elements missing! Check HTML IDs.');
                    return;
                }

                const email = emailInput.value;
                const password = passwordInput.value;

                if (!email || !password) {
                    alert('Please fill in both fields');
                    return;
                }

                // Προσομοίωση login (για demo)
                const user = {
                    id: Date.now(), // Καλύτερο από σταθερό ID
                    username: email.split('@')[0],
                    email: email,
                    name: email.split('@')[0] // Χρησιμοποιούμε το username ως name
                };

                setCurrentUser(user);

                closeModal('signinModal');
                alert('Signed in successfully!');
                signinForm.reset();
            });
        }

        // Allow search with Enter key on search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Αποτρέπει το default submit της φόρμας
                    searchMovies();
                }
            });
        }
    });


</script>
</body>
</html>