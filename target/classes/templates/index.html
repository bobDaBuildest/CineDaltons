<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>CineDaltons - Supabase Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" th:href="@{style.css}" href="style.css">
    <style>
        /* Βασική δομή για να λειτουργήσουν τα modals και οι κρυφές κλάσεις */
        .modal {
            display: none; /* Κρύβει όλα τα modals από προεπιλογή */
            position: fixed;
            z-index: 100; /* Αύξηση z-index για να είναι πάνω από όλα */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6); /* Πιο σκούρο background */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px; /* Λίγο μεγαλύτερο padding */
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            color: #333;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .hidden-app {
            display: none;
        }
        .top-right {
            position: fixed; /* Fixed για να μένει ορατό */
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 50;
        }
        .btn {
            background-color: #fdd835;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn:hover {
            background-color: #ffeb3b;
            transform: translateY(-1px);
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
        }

        /* Προσομοίωση του style.css για το watchlist toggle */
        #watchlist-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 15px;
            background-color: #fdd835;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            display: none; /* Αρχικά κρυμμένο */
        }
        #watchlist-toggle:hover {
            background-color: #ffeb3b;
            transform: scale(1.05);
        }
        #watchlist-container {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 300px;
            background-color: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        .hidden {
            display: none;
        }
        .movie {
            border: 1px solid #444;
            padding: 10px;
            margin: 10px;
            display: inline-block;
            width: 200px;
            text-align: center;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        .watchlist-item {
            border-bottom: 1px solid #444;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .watchlist-item:last-child {
            border-bottom: none;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        .welcome-message {
            font-size: 14px;
            color: #fdd835;
            margin-right: 10px;
        }
        .auth-forms input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body style="background-color: #1a1a1a; color: white; font-family: sans-serif;">

<div id="licenseModal" class="modal" style="display:block;">
    <div class="modal-content">
        <h2>License and Terms of Service</h2>
        <p>Please review and accept the terms to continue using CineDaltons.</p>
        <div class="license-text">
            <p><strong>1. Acceptance:</strong> By accessing or using the Service, you agree to be bound by these Terms.</p>
            <p><strong>2. API Usage:</strong> This application relies on the TMDb API. Use of search features is subject to TMDb's terms of use.</p>
            <p><strong>3. Disclaimer:</strong> CineDaltons is a demonstration project. We assume no liability for the content or functionality.</p>
            <p><strong>4. Data:</strong> We now use <strong>Supabase (PostgreSQL)</strong> for user authentication, watchlist, and preferences storage.</p>
        </div>
        <button class="btn submit-btn" onclick="acceptLicense()">Accept and Continue</button>
    </div>
</div>

<div id="appContent" class="hidden-app">
    <header class="top-right">
        <div id="auth-buttons">
        </div>
    </header>

    <div class="container" style="text-align: center; padding-top: 50px;">
        <img th:if="${error}" src="https://via.placeholder.com/100x100?text=Error" alt="Error" style="display: none;"/>
        <img th:if="${error}" src="/images/error-icon.png" alt="Error" style="display: none;"/>

        <h1>Welcome to CineDaltons</h1>
        <p>Discover and track your favorite movies</p>
    </div>

    <form action="/search" method="get" class="search-section" style="text-align: center; margin: 20px auto;">
        <input type="text" name="query" id="searchInput" placeholder="Search movies..." required
               style="padding: 10px; width: 400px; border-radius: 4px; border: none; background-color: #333; color: white;">
        <button type="button" class="btn" onclick="searchMovies()">Search</button>
    </form>

    <h2 style="text-align: center;">Search Results</h2>

    <div id="results" style="text-align: center;">
        <p>Search for a movie to see results here.</p>
    </div>
</div>

<button id="watchlist-toggle" onclick="toggleWatchlist()">
    Watchlist <span id="watchlist-badge">0</span>
</button>

<div id="watchlist-container" class="hidden">
    <h2>Your Watchlist</h2>
    <button class="btn" onclick="renderWatchlist()">Refresh</button>
    <div id="watchlist"></div>
</div>

<div id="signupModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('signupModal')">&times;</span>
        <h2>Create an account</h2>
        <form id="signupForm" class="signup-validation">
            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Username</label>
                <input type="text" id="su_username" required maxlength="50" style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">First Name</label>
                <input type="text" id="su_first" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Last Name</label>
                <input type="text" id="su_last" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Email</label>
                <input type="email" id="su_email" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Password</label>
                <div class="password-container">
                    <input type="password" id="su_password" required minlength="8" style="width: 100%; padding: 8px; box-sizing: border-box;"/>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="color: black; display: block; margin-bottom: 5px;">Confirm Password</label>
                <input type="password" id="su_confirmPassword" required style="width: 100%; padding: 8px; box-sizing: border-box;">
            </div>
            <div id="signup-error" class="error-message"></div>
            <button type="submit" class="submit-btn">Create Account</button>
        </form>
    </div>
</div>

<div id="signinModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('signinModal')">&times;</span>
        <h2>Sign In</h2>
        <form id="signInForm">
            <label style="color: black;">Email</label>
            <input type="email" id="si_email" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            <label style="color: black;">Password</label>
            <input type="password" id="si_password" required style="width: 100%; padding: 8px; box-sizing: border-box;"/>
            <div style="margin-top: 10px; text-align: right;">
                <button type="button" onclick="handlePasswordReset()" class="text-link">
                    Forgot Password?
                </button>
            </div>
            <div id="signin-error" class="error-message"></div>
            <button type="submit" class="submit-btn">Login</button>
        </form>
    </div>
</div>

<div id="genrePreferencesModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeModal('genrePreferencesModal')">&times;</span>
        <h2>Movie Genre Preferences</h2>
        <p>Select your favorite movie genres to get personalized recommendations!</p>
        <div id="pref-auth-warning" class="error-message" style="display: none;">
            Please sign in to save your preferences!
        </div>

        <form id="movieGenreForm">
            <div class="form-group">
                <label for="prefUsername" style="color: black;">Your Name</label>
                <input type="text" id="prefUsername" name="username" required disabled>
                <small style="color: gray; display: block;">(Username is retrieved from your account)</small>
            </div>

            <div class="form-group">
                <label style="color: black;">Select Your Favorite Movie Genres</label>
                <div class="checkbox-container" id="genreContainer">
                </div>
            </div>

            <div class="selected-count" style="color: black;">
                Selected: <span id="selectedCount">0</span> genres
            </div>

            <div class="success-message" id="successMessage" style="display:none; color: green; font-weight: bold;">
                Your genre preferences have been saved successfully!
            </div>

            <div class="form-actions">
                <button type="button" class="btn secondary-btn" id="resetBtn">Reset Selection</button>
                <button type="submit" class="btn submit-btn" id="savePrefBtn">Save Preferences</button>
            </div>
        </form>
        <hr>
        <h3 style="color: black;">My Saved Preferences</h3>
        <div id="preferencesDisplay" style="color: black;">No genre preferences saved yet.</div>
        <button class="btn" onclick="showPreferencesDisplay()">View/Refresh Saved</button>

    </div>
</div>


    <script>
        // ==============================================
        // 1. SUPABASE INITIALIZATION & API KEYS
        // ==============================================

        // !!! ΑΝΤΙΚΑΤΑΣΤΗΣΕ ΤΙΣ ΠΑΡΑΚΑΤΩ ΓΡΑΜΜΕΣ ΜΕ ΤΑ ΔΙΚΑ ΣΟΥ ΚΛΕΙΔΙΑ !!!
        const SUPABASE_URL = 'https://xyz1234.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xyz1234';

        const API_KEY = "fbdfbb87f57e7fd7d5778016a7b26f49";

        let currentAuthUser = null;
        let supabase = null;

        // ΑΣΦΑΛΗΣ ΔΗΜΙΟΥΡΓΙΑ ΤΟΥ SUPABASE CLIENT
        if (typeof supabaseJs !== 'undefined' && SUPABASE_URL && SUPABASE_ANON_KEY) {
        supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
        console.error("Supabase client creation failed: The library failed to load or keys are missing.");
        supabase = {
        auth: { onAuthStateChange: (callback) => { callback({ data: { user: null } }, null); return { data: { subscription: { unsubscribe: () => {} } } }; }, signOut: async () => ({ error: { message: 'Supabase not initialized' } }), getUser: async () => ({ data: { user: null }, error: { message: 'Supabase not initialized' } }) },
        from: () => ({ select: async () => ({ data: [], error: { message: 'Supabase not initialized' } }), insert: async () => ({ data: [], error: { message: 'Supabase not initialized' } }), delete: async () => ({ error: { message: 'Supabase not initialized' } }) })
    };
    }

        // ==============================================
        // 2. AUTHENTICATION STATE MANAGEMENT & UI
        // ==============================================

        async function updateUIForAuthState(session) {
        // Εάν δεν υπάρχει session, το τραβάμε μέσω getUser().
        const user = session?.user || (await supabase.auth.getUser())?.data?.user;
        currentAuthUser = user;
        const watchlistToggle = document.getElementById('watchlist-toggle');
        const authButtons = document.getElementById('auth-buttons');

        if (!authButtons || !watchlistToggle) {
        console.error("DOM Error: Required elements (auth-buttons or watchlist-toggle) not found.");
        return; // Διακοπή αν δεν βρεθούν τα στοιχεία
    }

        if (currentAuthUser) {
        const username = currentAuthUser.user_metadata?.username || currentAuthUser.email;

        watchlistToggle.style.display = 'block';
        authButtons.innerHTML = `
                <div class="user-info">
                    <span class="welcome-message">Welcome, ${username}</span>
                    <button class="btn" onclick="showPreferencesModal()">Genre Preferences</button>
                    <button class="btn" onclick="logout()">Logout</button>
                </div>
            `;
        renderWatchlist();
        closeModal('signinModal');
        closeModal('signupModal');
    } else {
        // Αυτό το block εμφανίζει τα κουμπιά Sign In/Up
        watchlistToggle.style.display = 'none';
        document.getElementById('watchlist-container').classList.add('hidden');
        authButtons.innerHTML = `
                <button class="btn" onclick="showPreferencesModal()">Genre Preferences</button>
                <button class="btn" onclick="openModal('signupModal')">Sign Up</button>
                <button class="btn" onclick="openModal('signinModal')">Sign In</button>
            `;
        document.getElementById("watchlist-badge").innerText = '0';
    }
    }

        async function handleAuthChange(event, session) {
        await updateUIForAuthState(session);
    }

        // ==============================================
        // 3. AUTHENTICATION METHODS (SUPABASE)
        // ==============================================
        // Στον index.html

        async function signUp(username, first_name, last_name, email, password) {
            document.getElementById('signup-error').innerText = '';
            if (!supabase || !supabase.auth) {
                document.getElementById('signup-error').innerText = 'System error: Supabase connection failed.';
                return false;
            }
            try {
                // ΒΗΜΑ 1: Εγγραφή στο Supabase Auth (Διαχείριση Κωδικού/Email)
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: { data: { username, first_name, last_name } } // Αποθήκευση στο Auth metadata
                });

                if (authError) throw authError;

                const user = authData.user;
                if (!user) {
                    document.getElementById('signup-error').innerText = 'Registration successful! Please check your email for a confirmation link.';
                    return true;
                }

                // ΒΗΜΑ 2: Εισαγωγή στον πίνακα public.users (για το username, κλπ.)
                // Αυτό λειτουργεί επειδή το RLS policy (Enable insert for all users) επιτρέπει την εισαγωγή.
                const { error: dbError } = await supabase
                    .from('users')
                    .insert([{ id: user.id, username, email, password, first_name, last_name }]);

                if (dbError) {
                    console.warn('Warning: Failed to insert data into public.users table. Check RLS and table structure.', dbError);
                }

                alert('Account created successfully! You are now logged in.');
                return true;

            } catch (error) {
                console.error('Sign Up Error:', error);
                document.getElementById('signup-error').innerText = error.message || 'An unexpected error occurred during sign up.';
                return false;
            }
        

    }

        async function signIn(email, password) {
        document.getElementById('signin-error').innerText = '';
        if (!supabase || !supabase.auth) return false;
        try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        alert('Signed in successfully!');
        return true;
    } catch (error) {
        console.error('Sign In Error:', error);
        document.getElementById('signin-error').innerText = error.message || 'Invalid login credentials.';
        return false;
    }
    }

        async function logout() {
        if (!supabase || !supabase.auth) return;
        const { error } = await supabase.auth.signOut();
        if (error) {
        console.error('Logout Error:', error);
        alert('Logout failed: ' + error.message);
    } else {
        alert('Logged out successfully!');
    }
    }

        async function handlePasswordReset() {
        const email = prompt("Enter your email address to reset your password:");
        if (email && supabase?.auth) {
        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
        if (error) {
        alert('Error sending password reset email: ' + error.message);
    } else {
        alert('Password reset link sent to your email!');
    }
    }
    }

        // ==============================================
        // 4. WATCHLIST FUNCTIONS (SUPABASE)
        // ==============================================

        async function getWatchlist() {
        if (!currentAuthUser || !supabase) return [];
        const { data, error } = await supabase.from('watchlist').select('*').eq('user_id', currentAuthUser.id);
        if (error) { console.error('Error fetching watchlist:', error); return []; }
        return data;
    }

        async function addToWatchlist(movie) {
        if (!currentAuthUser) { alert('Please sign in to add movies to your watchlist!'); openModal('signinModal'); return; }
        if (!supabase) return;
        const list = await getWatchlist();
        if (list.some(m => m.movie_id === movie.id)) { alert(`${movie.title} is already in your watchlist!`); return; }

        const { error } = await supabase
        .from('watchlist')
        .insert([{ user_id: currentAuthUser.id, movie_id: movie.id, title: movie.title, poster_path: movie.poster_path, release_date: movie.release_date }]);

        if (error) { console.error('Error adding to watchlist:', error); alert('Failed to add movie to watchlist. Check RLS policies.'); }
        else { alert(`${movie.title} added to watchlist!`); renderWatchlist(); }
    }

        async function removeFromWatchlist(id) {
        if (!currentAuthUser || !supabase) return;
        const { error } = await supabase
        .from('watchlist')
        .delete()
        .eq('movie_id', id)
        .eq('user_id', currentAuthUser.id);
        if (error) { console.error('Error removing from watchlist:', error); alert('Failed to remove movie. Check RLS policies.'); }
        else { renderWatchlist(); }
    }

        async function updateBadge() {
        const list = await getWatchlist();
        document.getElementById("watchlist-badge").innerText = list.length;
    }

        async function renderWatchlist() {
        const container = document.getElementById("watchlist");
        container.innerHTML = "";

        if (!currentAuthUser) { container.innerHTML = "<p>Please sign in to view your watchlist</p>"; document.getElementById("watchlist-badge").innerText = '0'; return; }

        container.innerHTML = "<p>Loading watchlist...</p>";
        const items = await getWatchlist();
        updateBadge();

        if (items.length === 0) { container.innerHTML = "<p>Your watchlist is empty.</p>"; return; }

        items.forEach(movie => {
        const item = document.createElement("div");
        item.className = "watchlist-item";
        item.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 5px 0;";
        item.innerHTML = `
                    <span title="${movie.title}">${movie.title.substring(0, 30)}${movie.title.length > 30 ? '...' : ''}</span>
                    <button class="btn" style="padding: 5px 10px;" onclick="removeFromWatchlist(${movie.movie_id})">X</button>
                `;
        container.appendChild(item);
    });
    }

        // ==============================================
        // 5. PREFERENCES FUNCTIONS (SUPABASE)
        // (Δεν αλλάζουν)

        async function getPreferences() {
        if (!currentAuthUser || !supabase) return { data: [], error: null };
        const { data, error } = await supabase.from('user_preferences').select('genre').eq('user_id', currentAuthUser.id);
        if (error) console.error('Error fetching preferences:', error);
        return { data, error };
    }

        async function savePreferences(selectedGenres) {
        if (!currentAuthUser || !supabase) return false;
        try {
        const { error: deleteError } = await supabase.from('user_preferences').delete().eq('user_id', currentAuthUser.id);
        if (deleteError) throw deleteError;

        const preferencesToInsert = selectedGenres.map(genre => ({ user_id: currentAuthUser.id, genre: genre }));
        const { error: insertError } = await supabase.from('user_preferences').insert(preferencesToInsert);
        if (insertError) throw insertError;

        return true;

    } catch (error) {
        console.error('Error saving preferences:', error);
        return false;
    }
    }

        async function showPreferencesDisplay() {
        const display = document.getElementById('preferencesDisplay');
        if (!currentAuthUser) { display.innerHTML = '<p>Please sign in to view your saved preferences.</p>'; return; }
        const { data, error } = await getPreferences();
        if (error || !data) { display.innerHTML = '<p>Error loading preferences.</p>'; return; }
        if (data.length === 0) { display.innerHTML = '<p>No genre preferences saved yet. Please select and save.</p>'; return; }

        const genreList = data.map(item => item.genre).join(', ');
        display.innerHTML = `<p><strong>Favorite Genres:</strong> ${genreList || 'None selected'}</p>`;
    }

        // ==============================================
        // 6. ΛΟΙΠΕΣ ΛΕΙΤΟΥΡΓΙΕΣ (TMDb, Modals, DOM)
        // ==============================================

        // Modal functions
        function openModal(id) { document.getElementById(id).style.display = "block"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        window.onclick = function(e) {
        document.querySelectorAll(".modal").forEach(modal => {
            if (e.target === modal && modal.id !== 'licenseModal') {
                modal.style.display = "none";
            }
        });
    };

        // License functions (Διορθώθηκε η κλήση της updateUI)
        function checkLicense() {
        const accepted = localStorage.getItem('licenseAccepted');
        const licenseModal = document.getElementById('licenseModal');
        const appContent = document.getElementById('appContent');
        if (!accepted) {
        licenseModal.style.display = "block";
        appContent.style.display = "none";
    } else {
        licenseModal.style.display = "none";
        appContent.style.display = "block";
        // Εμφάνιση UI μόλις γίνει accept
        updateUIForAuthState(null);
    }
    }
        function acceptLicense() {
        localStorage.setItem('licenseAccepted', 'true');
        document.getElementById('licenseModal').style.display = "none";
        document.getElementById('appContent').style.display = "block";
        // Εμφάνιση UI μετά την αποδοχή
        updateUIForAuthState(null);
    }

        // Search movies function
        async function searchMovies() {
        const query = document.getElementById("searchInput").value;
        const resultsDiv = document.getElementById("results");

        if (!query) { resultsDiv.innerHTML = "<p>Please enter a movie title to search.</p>"; return; }

        resultsDiv.innerHTML = "<h3>Searching...</h3>";

        try {
        const response = await fetch(
        `https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(query)}&api_key=${API_KEY}`
        );

        const data = await response.json();
        resultsDiv.innerHTML = "";

        if (data.results && data.results.length > 0) {
        data.results.forEach(movie => {
        const posterPath = movie.poster_path
        ? `https://image.tmdb.org/t/p/w200${movie.poster_path}`
        : 'https://via.placeholder.com/200x300?text=No+Image';

        const card = document.createElement("div");
        card.className = "movie";
        card.innerHTML = `
                            <img src="${posterPath}" alt="${movie.title}" style="max-width: 100%; height: auto;">
                            <h3 style="font-size: 1.1em; margin: 10px 0;">${movie.title}</h3>
                            <p style="margin: 5px 0;">${movie.release_date ? movie.release_date.substring(0,4) : 'N/A'}</p>
                            <button class="btn" onclick='addToWatchlist(${JSON.stringify({
        id: movie.id, title: movie.title, poster_path: movie.poster_path, release_date: movie.release_date
    })})'>
                                Add to Watchlist
                            </button>
                        `;
        resultsDiv.appendChild(card);
    });
    } else { resultsDiv.innerHTML = "<p>No movies found. Try a different search term.</p>"; }
    } catch (error) {
        console.error("Error fetching movies:", error);
        document.getElementById("results").innerHTML = "<p>Error searching for movies. Please check your API key or network connection.</p>";
    }
    }

        // Toggle watchlist panel
        function toggleWatchlist() {
        if (!currentAuthUser) { alert('Please sign in to view your watchlist!'); openModal('signinModal'); return; }
        document.getElementById("watchlist-container").classList.toggle("hidden");
        if (!document.getElementById("watchlist-container").classList.contains("hidden")) { renderWatchlist(); }
    }

        // ... (οι συναρτήσεις για τα Genres παραμένουν) ...
        const movieGenres = [
        { name: "Action", icon: "A" }, { name: "Adventure", icon: "AV" }, { name: "Animation", icon: "AN" },
        { name: "Comedy", icon: "C" }, { name: "Crime", icon: "CR" }, { name: "Documentary", icon: "D" },
        { name: "Drama", icon: "DR" }, { name: "Fantasy", icon: "F" }, { name: "Horror", icon: "H" },
        { name: "Mystery", icon: "M" }, { name: "Romance", icon: "R" }, { name: "Science Fiction", icon: "SF" },
        { name: "Thriller", icon: "T" }, { name: "Western", icon: "W" }
        ];

        function createGenreCheckboxes() {
        const container = document.getElementById('genreContainer');
        if (!container) return;
        container.innerHTML = '';
        movieGenres.forEach(genre => {
        const checkboxItem = document.createElement('div');
        checkboxItem.className = 'checkbox-item';
        checkboxItem.style.cssText = 'display: inline-block; margin: 5px;';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'genre-' + genre.name.toLowerCase().replace(/\s+/g, '-');
        checkbox.name = 'genres';
        checkbox.value = genre.name;

        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.style.marginLeft = '5px';
        label.style.color = 'black';

        const icon = document.createElement('span');
        icon.className = 'genre-icon';
        icon.textContent = genre.icon;
        icon.style.cssText = 'background-color: #fdd835; padding: 2px 5px; border-radius: 3px; font-weight: bold; color: black;';

        label.appendChild(icon);
        label.appendChild(document.createTextNode(' ' + genre.name));

        checkboxItem.appendChild(checkbox);
        checkboxItem.appendChild(label);
        container.appendChild(checkboxItem);
    });
    }

        function updateSelectedCount() {
        const selectedCountSpan = document.getElementById('selectedCount');
        if (!selectedCountSpan) return;
        const selectedCount = document.querySelectorAll('#genreContainer input:checked').length;
        selectedCountSpan.textContent = selectedCount;
    }

        function resetForm() {
        document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount();
    }

        async function handleGenreFormSubmit(event) {
        if (event && event.preventDefault) { event.preventDefault(); }
        if (!currentAuthUser) { document.getElementById('pref-auth-warning').style.display = 'block'; return; }

        const selectedGenres = Array.from(document.querySelectorAll('#genreContainer input:checked')).map(checkbox => checkbox.value);
        document.getElementById('savePrefBtn').disabled = true;

        const success = await savePreferences(selectedGenres);
        document.getElementById('savePrefBtn').disabled = false;

        const successMessage = document.getElementById('successMessage');
        if (successMessage) {
        successMessage.textContent = success ? 'Your genre preferences have been saved successfully!' : 'Failed to save preferences. Check console for error.';
        successMessage.style.color = success ? 'green' : 'red';
        successMessage.style.display = 'block';
        setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
    }

        showPreferencesDisplay();
    }

        async function initializeGenreForm() {
        createGenreCheckboxes();

        const prefUsername = document.getElementById('prefUsername');
        const savePrefBtn = document.getElementById('savePrefBtn');
        const prefAuthWarning = document.getElementById('pref-auth-warning');

        if (currentAuthUser) {
        const username = currentAuthUser.user_metadata?.username || currentAuthUser.email;
        prefUsername.value = username;
        savePrefBtn.disabled = false;
        prefAuthWarning.style.display = 'none';

        const { data } = await getPreferences();
        if (data) {
        const savedGenres = data.map(item => item.genre);
        document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = savedGenres.includes(checkbox.value);
    });
    }
    } else {
        prefUsername.value = '';
        savePrefBtn.disabled = true;
        prefAuthWarning.style.display = 'block';
        resetForm();
    }

        updateSelectedCount();

        document.querySelectorAll('#genreContainer input[type="checkbox"]').forEach(checkbox => {
        checkbox.removeEventListener('change', updateSelectedCount);
        checkbox.addEventListener('change', updateSelectedCount);
    });

        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn){
        resetBtn.removeEventListener('click', resetForm);
        resetBtn.addEventListener('click', resetForm);
    }

        const form = document.getElementById('movieGenreForm');
        if (form) {
        form.removeEventListener('submit', handleGenreFormSubmit);
        form.addEventListener('submit', handleGenreFormSubmit);
    }
    }

        function showPreferencesModal() {
        initializeGenreForm();
        showPreferencesDisplay();
        openModal('genrePreferencesModal');
    }

        // ==============================================
        // 7. DOM CONTENT LOADED - INITIALIZATION
        // ==============================================

        // Χρησιμοποιούμε απλό έλεγχο DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
        checkLicense();

        // 1. Supabase Auth Listener:
        if (supabase && supabase.auth) {
        supabase.auth.onAuthStateChange(handleAuthChange);
    } else {
        // Αν απέτυχε η αρχικοποίηση, καλούμε την updateUI για να δούμε τουλάχιστον τα κουμπιά Sign In/Up
        updateUIForAuthState(null);
    }

        // 2. Event Listeners για τις φόρμες Auth
        const signupForm = document.getElementById('signupForm');
        if (signupForm) {
        signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const username = document.getElementById('su_username').value;
        const email = document.getElementById('su_email').value;
        const password = document.getElementById('su_password').value;
        const confirmPassword = document.getElementById('su_confirmPassword').value;
        const first = document.getElementById('su_first').value;
        const last = document.getElementById('su_last').value;

        if (password !== confirmPassword) {
        document.getElementById('signup-error').innerText = 'Passwords do not match!';
        return;
    }

        const success = await signUp(username, first, last, email, password);
        if (success) signupForm.reset();
    });
    }

        const signinForm = document.getElementById('signInForm');
        if (signinForm) {
        signinForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const email = document.getElementById('si_email').value;
        const password = document.getElementById('si_password').value;

        const success = await signIn(email, password);
        if (success) signinForm.reset();
    });
    }

        // Allow search with Enter key on search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
        e.preventDefault();
        searchMovies();
    }
    });
    }
    });

</script>

</body>
</html>